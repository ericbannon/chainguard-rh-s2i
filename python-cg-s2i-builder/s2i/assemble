#!/bin/sh
set -euo pipefail

APP_DIR=/opt/app
SRC_DIR="${S2I_SOURCE_DIR:-/tmp/src}"
VENV_DIR="$APP_DIR/venv"

# copy source
mkdir -p "$APP_DIR"
cp -R "${SRC_DIR}/." "$APP_DIR/"

# create a project venv and install deps there
python -m venv "$VENV_DIR"
# use the venv's pip explicitly (no root needed)
"$VENV_DIR/bin/pip" install --no-cache-dir --upgrade pip wheel setuptools
if [ -f "$APP_DIR/requirements.txt" ]; then
  "$VENV_DIR/bin/pip" install --no-cache-dir -r "$APP_DIR/requirements.txt"
fi